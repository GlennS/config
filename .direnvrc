## Based on https://github.com/direnv/direnv/wiki/Nix#speeding-things-up
use_nix() {
    local cache=".direnv/cache-$(nixos-version --hash)"
    if [[ ! -e "$cache" ]] || \
           [[ "$HOME/.direnvrc" -nt "$cache" ]] || \
           [[ ".envrc" -nt "$cache" ]] || \
           [[ "default.nix" -nt "$cache" ]] || \
           [[ "shell.nix" -nt "$cache" ]];
    then
        [ -d .direnv ] || mkdir .direnv
        local tmp="$(mktemp "${cache}.tmp-XXXXXXXX")"
        trap "rm -rf '$tmp'" EXIT
        nix-shell --pure --show-trace "$@" --run 'direnv dump' > "$tmp" && mv "$tmp" "$cache"
    fi

    local term_backup="$TERM" ssh_auth_sock_backup="$SSH_AUTH_SOCK" editor_backup="$EDITOR"
    direnv_load cat "$cache"
    export TERM="$term_backup" SSH_AUTH_SOCK="$ssh_auth_sock_backup" EDITOR="$editor_backup"

    if [[ $# = 0 ]]; then
        watch_file default.nix
        watch_file shell.nix
    fi
}
